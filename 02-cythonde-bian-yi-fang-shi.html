<!DOCTYPE html>
<html lang="chinese (simplified)">
<head>
        <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wikibook | 02-cython的编译方式</title>
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="sniper" />

    <meta name="keywords" content="cython" />
</head>
<body>
    <header>
        <nav style="overflow: hidden;">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="https://github.com/">GitHub</a></li>
                <li><a href="/tags">Tags</a></li>
                <li><a href="/authors">Authors</a></li>
                <li><a href="/categories">Categories</a></li>
                <li><a href="/archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box" style="height: 50px">
        <h1><a href="/">
            <image src='' class="avatar" width="50px" /><span class="site_title">wikibook</span>
            </a></h1></div>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">12月 03, 2010</h4>

            <article class="post">
                <h2 class="title">
                    <a href="/02-cythonde-bian-yi-fang-shi.html" rel="bookmark" title="Permanent Link to &quot;02-cython的编译方式&quot;">02-cython的编译方式</a>
                </h2>

                
                

                <ul>
<li><a href="#编译过程">编译过程</a></li>
<li><a href="#环境搭建">环境搭建</a></li>
<li><a href="#一distutils-手动编译">一、distutils 手动编译</a></li>
<li><a href="#11-只编译cython代码">1.1 只编译Cython代码</a></li>
<li><a href="#12-编译引入c代码的cython代码">1.2 编译引入C代码的Cython代码</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#二通过-ipython-动态交互-cython">二、通过 IPython 动态交互 Cython</a></li>
<li><a href="#三导包的时候编译">三、导包的时候编译</a></li>
<li><a href="#31-使用-pximport-即时编译">3.1 使用 pximport 即时编译</a></li>
<li><a href="#32-控制-pyximport-并管理依赖">3.2 控制 pyximport 并管理依赖</a></li>
</ul>
<h1>编译过程</h1>
<ol>
<li>
<p>cython 编译器负责将 Cython 转换成经过优化并且依赖当前平台的 C、C++ 代码</p>
</li>
<li>
<p>使用标准的 C、C++ 编译器将第一步得到的 C、C++ 代码进行编译并生成标准的扩展模块</p>
<ul>
<li>扩展模块依赖特定的平台. linux平台, 编译生成so扩展; windows平台, 编译生成pyd扩展</li>
<li>扩展模块可以直接被 Python 解释器进行 import</li>
</ul>
</li>
</ol>
<h1>环境搭建</h1>
<ol>
<li>
<p>安装C、C++编译器</p>
<ul>
<li>linux平台</li>
<li>自带gcc, 无需安装</li>
<li>
<p>yum install python3-devel</p>
</li>
<li>
<p>windows平台</p>
</li>
<li>下载Visual Studio 或者 安装<a href="https://sourceforge.net/projects/mingw/files/">MinGW</a>并设置到环境变量中</li>
<li><a href="https://zhuanlan.zhihu.com/p/471661231">详见</a></li>
</ul>
</li>
<li>
<p>安装Cython编译器</p>
<p>pip install cython</p>
</li>
</ol>
<h1>一、distutils 手动编译</h1>
<h2>1.1 只编译Cython代码</h2>
<p><a href="https://gitlab.com/pymango/cython/-/tree/master/Cython%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/Cython%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91/build_cython">详见</a></p>
<ol>
<li>
<p>编写编译脚本build.py
    ```python
    from distutils.core import setup
    from Cython.Build import cythonize</p>
<p>setup(ext_modules=cythonize("fib.pyx", language_level=3))
```</p>
</li>
<li>
<p>执行编译命令</p>
<p><code>python.exe build.py build</code></p>
</li>
</ol>
<h2>1.2 编译引入C代码的Cython代码</h2>
<p><a href="https://gitlab.com/pymango/cython/-/tree/master/Cython%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/Cython%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91/build_cython_c">详见</a></p>
<ol>
<li>
<p>编写编译脚本build.py
    ```python
    from distutils.core import setup, Extension
    from Cython.Build import cythonize</p>
<p>ext = Extension(name="fib", sources=["fib.pyx", "cfib.c"])
setup(ext_modules=cythonize(ext))
```</p>
</li>
<li>
<p>执行编译命令</p>
<p><code>python.exe build.py build</code></p>
</li>
<li>
<p>可能出错</p>
<ul>
<li><a href="https://blog.csdn.net/weixin_41423872/article/details/124407109">解决方案参考</a></li>
</ul>
</li>
</ol>
<h2>总结</h2>
<ul>
<li>如果是单个 pyx 文件的话, 那么直接通过 cythonize("xxx.pyx") 即可</li>
<li>如果 pyx 文件还引入了 C 文件, 那么通过 cythonize(Extension(name="xx", sources=["", ""])) 的方式即可; name 是编译之后的扩展模块的名字, sources 是你要编译的源文件</li>
</ul>
<h1>二、通过 IPython 动态交互 Cython</h1>
<ul>
<li>jupyter notebook同理</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 我们在 IPython 上运行，执行 %load_ext cython 便会加载 Cython 的一些魔法函数</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">cython</span>

<span class="c1"># 然后神奇的一幕出现了，加上一个魔法命令，就可以直接写 Cython 代码</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%%</span><span class="n">cython</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="s2">&quot;&quot;&quot;这是一个 Cython 函数，在 IPython 上编写&quot;&quot;&quot;</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">cdef</span> <span class="n">double</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>         <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">return</span> <span class="n">a</span>
<span class="n">_cython_magic_0c221c85b2c3d523d965f7911ee5a741</span><span class="o">.</span><span class="n">c</span>
<span class="n">_cython_magic_0c221c85b2c3d523d965f7911ee5a741</span><span class="o">.</span><span class="n">obj</span> <span class="p">:</span> <span class="n">warning</span> <span class="n">LNK4197</span><span class="p">:</span> <span class="n">export</span> <span class="s1">&#39;PyInit__cython_magic_0c221c85b2c3d523d965f7911ee5a741&#39;</span> <span class="n">specified</span> <span class="n">multiple</span> <span class="n">times</span><span class="p">;</span> <span class="n">using</span> <span class="n">first</span> <span class="n">specification</span>
   <span class="n">Creating</span> <span class="n">library</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">CP</span>\<span class="o">.</span><span class="n">ipython</span>\<span class="n">cython</span>\<span class="n">Users</span>\<span class="n">CP</span>\<span class="o">.</span><span class="n">ipython</span>\<span class="n">cython</span>\<span class="n">_cython_magic_0c221c85b2c3d523d965f7911ee5a741</span><span class="o">.</span><span class="n">cp39</span><span class="o">-</span><span class="n">win_amd64</span><span class="o">.</span><span class="n">lib</span> <span class="ow">and</span> <span class="nb">object</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">CP</span>\<span class="o">.</span><span class="n">ipython</span>\<span class="n">cython</span>\<span class="n">Users</span>\<span class="n">CP</span>\<span class="o">.</span><span class="n">ipython</span>\<span class="n">cython</span>\<span class="n">_cython_magic_0c221c85b2c3d523d965f7911ee5a741</span><span class="o">.</span><span class="n">cp39</span><span class="o">-</span><span class="n">win_amd64</span><span class="o">.</span><span class="n">exp</span>
<span class="n">Generating</span> <span class="n">code</span>
<span class="n">Finished</span> <span class="n">generating</span> <span class="n">code</span>

<span class="c1"># 测试用时, 平均花费34.2ns</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">fib</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="mf">34.2</span> <span class="n">ns</span> <span class="err">±</span> <span class="mf">0.399</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="err">±</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</code></pre></div>

<h1>三、导包的时候编译</h1>
<h2>3.1 使用 pximport 即时编译</h2>
<p><a href="https://gitlab.com/pymango/cython/-/tree/master/Cython%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/Cython%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91/pxinport_compile">代码见</a>
- Cython 源文件不会立刻编译, 只有当被导入的时候才会编译
- Cython 源文件不变, 不会重复编译; Cython 源文件被修改, pyximport 会自动检测, 会重新编译</p>
<div class="highlight"><pre><span></span><code><span class="c1"># add.pyx</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="c1"># build.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pyximport</span>
<span class="c1"># 这里同样指定 language_level=3, 则表示针对的是py3, 因为这种方式也是要编译的</span>
<span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">language_level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># 执行完之后, Python 解释器在导包的时候就会识别 Cython 文件了, 当然会先进行编译</span>

<span class="kn">import</span> <span class="nn">add</span>
<span class="nb">print</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
</code></pre></div>

<h2>3.2 控制 pyximport 并管理依赖</h2>
<p><a href="https://gitlab.com/pymango/cython/-/tree/master/Cython%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/Cython%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91/pyximport_compile">代码见</a>
- .pyxbld 文件要和 .pyx 文件具有相同的基名, 且它们要位于同一目录中</p>
<div class="highlight"><pre><span></span><code><span class="c1"># fib.pyxbld</span>
<span class="kn">from</span> <span class="nn">distutils.extension</span> <span class="kn">import</span> <span class="n">Extension</span>

<span class="k">def</span> <span class="nf">make_ext</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">pyxfilename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Extension</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span>
                     <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">pyxfilename</span><span class="p">,</span> <span class="s2">&quot;../build_cython_c/cfib.c&quot;</span><span class="p">],</span>
                     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;../build_cython_c/&quot;</span><span class="p">])</span>

<span class="c1"># build.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pyximport</span>
<span class="n">pyximport</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">language_level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">fib</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fib</span><span class="o">.</span><span class="n">fib_with_c</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
</code></pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="/02-cythonde-bian-yi-fang-shi.html">posted at 10:20</a>
                    &nbsp;&middot;&nbsp;<a href="/category/python.html" rel="tag">Python</a>
                    &nbsp;&middot;
                    &nbsp;<a href="/tag/cython.html" class="tags">cython</a>
                </div>
            </article>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>